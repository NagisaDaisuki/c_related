# =========================================================================
# 1. 变量和路径定义
# =========================================================================
CC = gcc
CFLAGS = -Wall -g

# VPATH 告诉 make 在哪里寻找依赖文件和源文件
VPATH = src:include

# 我们可以使用通配符来自动获取源文件和头文件，无需手动列出
SRCS := $(wildcard src/*.c)
HDRS := $(wildcard include/*.h)

# 从源文件列表中推导出目标文件列表
OBJS := $(patsubst src/%.c, obj/%.o, $(SRCS))

TARGET = hello

# 专门存放目标文件的目录
OBJ_DIR = obj

# =========================================================================
# 2. 编译和链接规则
# =========================================================================
.PHONY: all
all: $(TARGET)

# 链接规则：将所有 .o 文件链接为最终的可执行文件
$(TARGET): $(OBJS)
	$(CC) $(CFLAGS) -o $@ $^

# 编译规则：将 src/ 目录下的 .c 文件编译到 obj/ 目录下
# -I 选项告诉编译器去 include 目录寻找头文件
$(OBJ_DIR)/%.o: %.c $(HDRS)
	@mkdir -p $(OBJ_DIR)
	$(CC) $(CFLAGS) -I$(dir $(HDRS)) -c $< -o $@

# -------------------------------------------------------------------------
# 3. 自动生成头文件依赖 (推荐的最佳实践)
# -------------------------------------------------------------------------
# 这部分确保在头文件修改时，make 能正确地重新编译依赖的 .c 文件
# OBJS 的 .o 后缀被替换为 .d，表示依赖文件
DEPS := $(OBJS:.o=.d)

# 告诉 make 包含这些自动生成的依赖文件
-include $(DEPS)

# 依赖文件生成规则
$(OBJ_DIR)/%.d: %.c
	@set -e; rm -f $@; \
	$(CC) -MM $(CFLAGS) -I$(dir $(HDRS)) $< > $@.$$$$; \
	sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ >> $@; \
	rm -f $@.$$$$


# =========================================================================
# 4. 清理规则
# =========================================================================
.PHONY: clean
clean:
	@rm -rf $(OBJ_DIR) $(TARGET)
