# ====================================================================================
# 1. 变量和路径定义
# ====================================================================================

ifndef CC
	CC = gcc 
endif

ifndef CFLAGS
	CFLAGS = -Wall -g 
endif

VPATH = src:include
# vpath %.h include
# vpath %.c src

OBJ_DIR = obj
SRC_DIR = src
HDR_DIR = include

SRCS := $(wildcard $(SRC_DIR)/*.c)
HDRS := $(wildcard $(HDR_DIR)/*.h)

OBJS := $(patsubst $(SRC_DIR)/%.c, $(OBJ_DIR)/%.o, $(SRCS))

TARGET = hello


# ====================================================================================
# 2. 编译和链接规则
# ====================================================================================

.PHONY: all
all: $(TARGET)

$(TARGET): $(OBJS)
	$(CC) $(CFLAGS) -o $@ $^

$(OBJ_DIR)/%.o: %.c $(HDRS)
	@mkdir -p $(OBJ_DIR)
	$(CC) $(CFLAGS) -I$(dir $(HDRS)) -c $< -o $@



# ====================================================================================
# 3. 自动生成头文件依赖
# ====================================================================================

DEPS := $(OBJS:.o=.d)

-include $(DEPS)

$(OBJ_DIR)/%.d: %.c
	@set -e; rm -f $@; \
	$(CC) -MM $(CFLAGS) -I$(dir $(HDRS))  $< > $@.$$$$; \
	sed 's,\($*)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ >> $@; \
	rm -f $@.$$$$


# ====================================================================================
# 4. 清理规则
# ====================================================================================

.PHONY: clean
clean: 
	@rm -rf $(OBJ_DIR) $(TARGET)
